name: Build APK

on:
  workflow_dispatch:
    inputs:
      build_release:
        description: "Build release APK (assembleRelease). If false, builds debug (assembleDebug)."
        type: boolean
        required: false
        default: false
      create_github_release:
        description: "Create a GitHub Release and upload the APK."
        type: boolean
        required: false
        default: false
      tag:
        description: "Release tag. Default: versionName"
        type: string
        required: false
        default: ""
      title:
        description: "Release title. Default: versionName"
        type: string
        required: false
        default: ""

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Read versionName
        id: version
        shell: bash
        run: |
          set -euo pipefail
          VERSION_NAME=$(grep -m1 -E 'versionName\s*=\s*"' app/build.gradle.kts | sed -E 's/.*"([^"]+)".*/\1/')
          if [ -z "$VERSION_NAME" ]; then
            echo "Failed to read versionName from app/build.gradle.kts" >&2
            exit 1
          fi
          echo "version_name=$VERSION_NAME" >> "$GITHUB_OUTPUT"

      - name: Build APK
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ inputs.build_release }}" = "true" ]; then
            ./gradlew :app:assembleRelease
          else
            ./gradlew :app:assembleDebug
          fi

      - name: Collect APK
        id: apk
        shell: bash
        run: |
          set -euo pipefail
          VARIANT=debug
          if [ "${{ inputs.build_release }}" = "true" ]; then
            VARIANT=release
          fi

          APK_PATH=$(ls -1 app/build/outputs/apk/${VARIANT}/*.apk | head -n 1)
          if [ -z "${APK_PATH:-}" ]; then
            echo "No APK found under app/build/outputs/apk/${VARIANT}" >&2
            exit 1
          fi

          VERSION_NAME="${{ steps.version.outputs.version_name }}"
          APP_NAME="TapAPDU"
          OUT_DIR="dist"
          mkdir -p "$OUT_DIR"

          OUT_NAME="${APP_NAME}-${VERSION_NAME}-${VARIANT}.apk"
          cp "$APK_PATH" "$OUT_DIR/$OUT_NAME"

          echo "apk_path=$OUT_DIR/$OUT_NAME" >> "$GITHUB_OUTPUT"
          echo "apk_name=$OUT_NAME" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.apk.outputs.apk_name }}
          path: ${{ steps.apk.outputs.apk_path }}
          if-no-files-found: error

      - name: Create GitHub Release
        if: ${{ inputs.create_github_release }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag != '' && inputs.tag || steps.version.outputs.version_name }}
          name: ${{ inputs.title != '' && inputs.title || steps.version.outputs.version_name }}
          files: ${{ steps.apk.outputs.apk_path }}
